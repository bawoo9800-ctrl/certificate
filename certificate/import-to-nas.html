<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ìŠ¤ DBë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .import-container {
            max-width: 900px;
            margin: 50px auto;
            padding: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        
        .import-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .import-header h1 {
            font-size: 2.5rem;
            color: #333;
            margin-bottom: 15px;
        }
        
        .import-header .subtitle {
            font-size: 1.2rem;
            color: #666;
        }
        
        .step-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            border: 2px solid #e0e0e0;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .step-number {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .step-title {
            font-size: 1.6rem;
            color: #333;
            font-weight: 600;
        }
        
        .step-content {
            padding-left: 65px;
        }
        
        .btn-import {
            width: 100%;
            padding: 18px;
            font-size: 1.2rem;
            font-weight: 600;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s;
        }
        
        .btn-import:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.5);
        }
        
        .btn-import:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        #fileInput {
            display: none;
        }
        
        .file-info {
            background: #e3f2fd;
            border: 2px solid #2196F3;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            display: none;
            color: #1565c0;
        }
        
        .file-info i {
            margin-right: 8px;
        }
        
        .info-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #856404;
        }
        
        .info-box i {
            margin-right: 8px;
        }
        
        .info-box p {
            margin: 5px 0;
        }
        
        .result-box {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        
        .result-box.success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
            display: block;
        }
        
        .result-box.error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
            display: block;
        }
        
        .result-box i {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 40px;
            background: #e0e0e0;
            border-radius: 20px;
            overflow: hidden;
            margin-top: 20px;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: width 0.3s;
            width: 0%;
        }
        
        .detail-results {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }
        
        .detail-results h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .detail-results p {
            margin: 5px 0;
            padding-left: 20px;
        }
    </style>
    

</head>
<body>
    <!-- í—¤ë” -->
    <header>
        <div class="container">
            <div class="logo">
                <i class="fas fa-award"></i>
                <span>í’ˆì§ˆì¸ì •ì„œ ë°œê¸‰ ì‹œìŠ¤í…œ</span>
            </div>
            <nav>
                <a href="index.html"><i class="fas fa-home"></i> í™ˆ</a>
                <a href="history.html"><i class="fas fa-history"></i> ë°œí–‰ë‚´ì—­</a>
                <a href="import-to-nas.html" class="active"><i class="fas fa-upload"></i> ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</a>
            </nav>
        </div>
    </header>

    <div class="import-container">
        <div class="import-header">
            <h1><i class="fas fa-upload"></i> ë‚˜ìŠ¤ DBë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</h1>
            <p class="subtitle">ì  ìŠ¤íŒŒí¬ ê°œë°œí™˜ê²½ â†’ ë‚˜ìŠ¤ DB ë§ˆì´ê·¸ë ˆì´ì…˜</p>
        </div>

        <!-- Step 1: JSON íŒŒì¼ ì„ íƒ -->
        <div class="step-card">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-title">JSON íŒŒì¼ ì„ íƒ</div>
            </div>
            <div class="step-content">
                <p style="margin-bottom: 15px; color: #666;">
                    ì  ìŠ¤íŒŒí¬ì—ì„œ ë‹¤ìš´ë¡œë“œí•œ JSON íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.
                </p>
                <input type="file" id="fileInput" accept=".json" onchange="handleFileSelect(event)">
                <button class="btn-import" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-file-upload"></i>
                    JSON íŒŒì¼ ì„ íƒ
                </button>
                <div id="fileInfo" class="file-info"></div>
                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    <p><strong>íŒŒì¼ëª… ì˜ˆì‹œ:</strong> genspark_export_2025-01-13.json</p>
                    <p><strong>ìœ„ì¹˜:</strong> C:\Users\ì‚¬ìš©ìëª…\Downloads\</p>
                </div>
            </div>
        </div>

        <!-- Step 2: ë°ì´í„° ê°€ì ¸ì˜¤ê¸° -->
        <div class="step-card">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-title">ë‚˜ìŠ¤ DBì— ì—…ë¡œë“œ</div>
            </div>
            <div class="step-content">
                <p style="margin-bottom: 15px; color: #666;">
                    íŒŒì¼ ì„ íƒ í›„ ìë™ìœ¼ë¡œ ë‚˜ìŠ¤ DBì— ì—…ë¡œë“œë©ë‹ˆë‹¤.
                </p>
                <div class="info-box">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p><strong>ì£¼ì˜ì‚¬í•­:</strong></p>
                    <p>â€¢ ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤ (ë®ì–´ì“°ê¸° ì—†ìŒ)</p>
                    <p>â€¢ ì¤‘ë³µëœ IDëŠ” ìë™ìœ¼ë¡œ ê±´ë„ˆëœë‹ˆë‹¤</p>
                    <p>â€¢ ë°°ì¹˜ ì²˜ë¦¬: 10ê±´ì”© ë‚˜ëˆ ì„œ ì•ˆì „í•˜ê²Œ ì—…ë¡œë“œ</p>
                </div>
                <div id="importProgress" class="progress-bar">
                    <div class="progress-fill" id="importProgressFill">0%</div>
                </div>
                <div id="importResult" class="result-box"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedFileData = null;

        // íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('ğŸ“ íŒŒì¼ ì„ íƒë¨:', file.name);
            
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.style.display = 'block';
            fileInfo.innerHTML = `
                <i class="fas fa-file-alt"></i>
                <strong>ì„ íƒëœ íŒŒì¼:</strong> ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)
            `;
            
            // íŒŒì¼ ì½ê¸°
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    console.log('âœ… JSON íŒŒì¼ ì½ê¸° ì™„ë£Œ');
                    console.log('ğŸ“Š ë°ì´í„° êµ¬ì¡°:', data);
                    
                    selectedFileData = data;
                    
                    // ìë™ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸° ì‹œì‘
                    importData(data);
                    
                } catch (error) {
                    console.error('âŒ JSON íŒŒì‹± ì˜¤ë¥˜:', error);
                    
                    const importResult = document.getElementById('importResult');
                    importResult.className = 'result-box error';
                    importResult.style.display = 'block';
                    importResult.innerHTML = `
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>íŒŒì¼ ì½ê¸° ì˜¤ë¥˜!</strong><br>
                        ìœ íš¨í•œ JSON íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.<br>
                        ${error.message}
                    `;
                }
            };
            reader.readAsText(file);
        }

        // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function importData(data) {
            try {
                console.log('ğŸ“¥ ë‚˜ìŠ¤ DBë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘');
                
                const importProgress = document.getElementById('importProgress');
                const importProgressFill = document.getElementById('importProgressFill');
                const importResult = document.getElementById('importResult');
                
                importProgress.style.display = 'block';
                importResult.style.display = 'none';
                
                // ë°ì´í„° ì¶”ì¶œ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›)
                let certificates = [];
                let companySites = [];
                
                // ì  ìŠ¤íŒŒí¬ Table í˜•ì‹
                if (data.tables) {
                    certificates = data.tables.certificates?.data || [];
                    companySites = data.tables.company_sites?.data || [];
                }
                // ì´ì¹´ìš´íŠ¸ ë³€í™˜ í˜•ì‹
                else if (data.data && Array.isArray(data.data)) {
                    certificates = data.data;
                }
                // ì§ì ‘ ë°°ì—´ í˜•ì‹
                else if (Array.isArray(data)) {
                    certificates = data;
                }
                
                console.log('ğŸ“Š certificates:', certificates.length + 'ê±´');
                console.log('ğŸ“Š company_sites:', companySites.length + 'ê±´');
                
                let results = {
                    certificates: { success: 0, skipped: 0, failed: 0 },
                    company_sites: { success: 0, skipped: 0, failed: 0 }
                };
                
                // certificates ì—…ë¡œë“œ
                console.log('ğŸ”„ certificates ì—…ë¡œë“œ ì‹œì‘...');
                for (let i = 0; i < certificates.length; i += 10) {
                    const batch = certificates.slice(i, i + 10);
                    
                    for (const record of batch) {
                        try {
                            // ID ì¤‘ë³µ ì²´í¬
                            const checkResponse = await fetch(`api/certificates.php?id=${record.id}`);
                            
                            if (checkResponse.ok) {
                                const existing = await checkResponse.json();
                                if (existing && existing.id === record.id) {
                                    console.log(`â­ï¸ ê±´ë„ˆëœ€ (ì¤‘ë³µ ID): ${record.id}`);
                                    results.certificates.skipped++;
                                    continue;
                                }
                            }
                            
                            // ìƒˆ ë°ì´í„° ì¶”ê°€
                            const createResponse = await fetch('api/certificates.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(record)
                            });
                            
                            if (createResponse.ok) {
                                results.certificates.success++;
                                console.log(`âœ… ì¶”ê°€ ì™„ë£Œ: ${record.id}`);
                            } else {
                                throw new Error(`HTTP ${createResponse.status}`);
                            }
                            
                        } catch (error) {
                            console.error(`âŒ ì‹¤íŒ¨: ${record.id}`, error);
                            results.certificates.failed++;
                        }
                    }
                    
                    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                    const progress = Math.round(((i + batch.length) / (certificates.length + companySites.length)) * 100);
                    importProgressFill.style.width = progress + '%';
                    importProgressFill.textContent = progress + '%';
                    
                    // API ë¶€í•˜ ë°©ì§€
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // company_sites ì—…ë¡œë“œ
                console.log('ğŸ”„ company_sites ì—…ë¡œë“œ ì‹œì‘...');
                for (let i = 0; i < companySites.length; i += 10) {
                    const batch = companySites.slice(i, i + 10);
                    
                    for (const record of batch) {
                        try {
                            // ì¤‘ë³µ ì²´í¬ (ì—…ì²´ëª… + í˜„ì¥ëª…)
                            const checkResponse = await fetch(`api/company_sites.php?company=${encodeURIComponent(record.companyName)}&site=${encodeURIComponent(record.siteName)}`);
                            
                            if (checkResponse.ok) {
                                const existing = await checkResponse.json();
                                if (existing && existing.length > 0) {
                                    console.log(`â­ï¸ ê±´ë„ˆëœ€ (ì¤‘ë³µ): ${record.companyName} - ${record.siteName}`);
                                    results.company_sites.skipped++;
                                    continue;
                                }
                            }
                            
                            // ìƒˆ ë°ì´í„° ì¶”ê°€
                            const createResponse = await fetch('api/company_sites.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(record)
                            });
                            
                            if (createResponse.ok) {
                                results.company_sites.success++;
                                console.log(`âœ… ì¶”ê°€ ì™„ë£Œ: ${record.companyName} - ${record.siteName}`);
                            } else {
                                throw new Error(`HTTP ${createResponse.status}`);
                            }
                            
                        } catch (error) {
                            console.error(`âŒ ì‹¤íŒ¨: ${record.companyName}`, error);
                            results.company_sites.failed++;
                        }
                    }
                    
                    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                    const progress = Math.round(((certificates.length + i + batch.length) / (certificates.length + companySites.length)) * 100);
                    importProgressFill.style.width = progress + '%';
                    importProgressFill.textContent = progress + '%';
                    
                    // API ë¶€í•˜ ë°©ì§€
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // ì™„ë£Œ
                importProgressFill.style.width = '100%';
                importProgressFill.textContent = '100%';
                
                console.log('âœ… ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ');
                console.log('ğŸ“Š ê²°ê³¼:', results);
                
                // ê²°ê³¼ í‘œì‹œ
                importResult.className = 'result-box success';
                importResult.style.display = 'block';
                importResult.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <strong>ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!</strong><br>
                    <div class="detail-results">
                        <h4>ğŸ“‹ certificates (ë°œê¸‰ ë‚´ì—­)</h4>
                        <p>âœ… ì„±ê³µ: <strong>${results.certificates.success}ê±´</strong></p>
                        <p>â­ï¸ ê±´ë„ˆëœ€: ${results.certificates.skipped}ê±´ (ì¤‘ë³µ ID)</p>
                        <p>âŒ ì‹¤íŒ¨: ${results.certificates.failed}ê±´</p>
                        
                        <h4 style="margin-top: 15px;">ğŸ¢ company_sites (ì—…ì²´/í˜„ì¥)</h4>
                        <p>âœ… ì„±ê³µ: <strong>${results.company_sites.success}ê±´</strong></p>
                        <p>â­ï¸ ê±´ë„ˆëœ€: ${results.company_sites.skipped}ê±´ (ì¤‘ë³µ)</p>
                        <p>âŒ ì‹¤íŒ¨: ${results.company_sites.failed}ê±´</p>
                        
                        <h4 style="margin-top: 15px;">ğŸ“Š ì´ê³„</h4>
                        <p>âœ… ì´ ì„±ê³µ: <strong>${results.certificates.success + results.company_sites.success}ê±´</strong></p>
                    </div>
                    <br>
                    <a href="history.html" style="display: inline-block; margin-top: 15px; padding: 10px 20px; background: #10b981; color: white; text-decoration: none; border-radius: 8px;">
                        <i class="fas fa-history"></i> ë°œí–‰ ë‚´ì—­ í™•ì¸í•˜ê¸°
                    </a>
                `;
                
                setTimeout(() => {
                    importProgress.style.display = 'none';
                    importProgressFill.style.width = '0%';
                }, 3000);
                
            } catch (error) {
                console.error('âŒ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                
                const importResult = document.getElementById('importResult');
                importResult.className = 'result-box error';
                importResult.style.display = 'block';
                importResult.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i>
                    <strong>ì˜¤ë¥˜ ë°œìƒ!</strong><br>
                    ${error.message}
                `;
                
                document.getElementById('importProgress').style.display = 'none';
            }
        }

        console.log('ğŸš€ ë‚˜ìŠ¤ DB ë°ì´í„° ê°€ì ¸ì˜¤ê¸° í˜ì´ì§€ ë¡œë“œë¨');
        console.log('ğŸ“‚ JSON íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”');
    </script>
</body>
</html>
